{
  "rules": {
    ".read":"
    auth.uid === 'my-service-worker'
    ||
    root.child('authorized/'+auth.uid).exists()
    ",
    "Inbox":{
      "$id":{
        ".validate":"newData.hasChildren(['time','topic','content'])",
        ".write":"
        (
          !data.exists()
          &&
         	(
          	(
            	root.child('Archived/'+$id).exists()
              &&
              !newData.parent().parent().child('Archived/'+$id).exists()
              &&
              root.child('Archived/'+$id+'/time').val()==newData.child('time').val()
              &&
              root.child('Archived/'+$id+'/email').val()==newData.child('email').val()
              &&
              root.child('Archived/'+$id+'/topic').val()==newData.child('topic').val()
              &&
              root.child('Archived/'+$id+'/content').val()==newData.child('content').val()
            )
            ||
            (
            	root.child('Trash/'+$id).exists()
              &&
              !newData.parent().parent().child('Trash/'+$id).exists()
              &&
              root.child('Trash/'+$id+'/time').val()==newData.child('time').val()
              &&
              root.child('Trash/'+$id+'/email').val()==newData.child('email').val()
              &&
              root.child('Trash/'+$id+'/topic').val()==newData.child('topic').val()
              &&
              root.child('Trash/'+$id+'/content').val()==newData.child('content').val()
            )
          ) 
        )
        ||
        (
        	!newData.exists()
          &&
         	(
          	(
            	newData.parent().parent().child('Archived/'+$id).exists()
              &&
              !newData.parent().parent().child('Trash/'+$id).exists()
            )
            ||
            (
            	!newData.parent().parent().child('Archived/'+$id).exists()
              &&
              newData.parent().parent().child('Trash/'+$id).exists()
            )
          ) 
        )
        ||
        (
        	auth.uid === 'my-service-worker'
          &&
          newData.hasChildren(['time','topic','content'])
        )",
        "time":{".validate":"newData.isNumber()"},
      	"email":{".validate":"newData.isString()"},
      	"topic":{".validate":"newData.isString()"},
      	"content":{".validate":"newData.isString()"},
        "$other":{".validate":"false"}
      }
  	},
    "Archived":{
      "$id":{
        ".write":"(root.child('Inbox/'+$id).exists()
        &&
        !newData.parent().parent().child('Inbox/'+$id).exists()
        )
        ||
        !newData.exists() 
        ",
        ".validate":"newData.hasChildren(['time','topic','content'])",
        "time":{".validate":"root.child('Inbox/'+$id+'/time').val()==newData.val()"},
      	"email":{".validate":"root.child('Inbox/'+$id+'/email').val()==newData.val()"},
      	"topic":{".validate":"root.child('Inbox/'+$id+'/topic').val()==newData.val()"},
      	"content":{".validate":"root.child('Inbox/'+$id+'/content').val()==newData.val()"},
        "$other":{".validate":"false"}
      }
  	},
    "Trash":{
      "$id":{
        ".write":"(root.child('Inbox/'+$id).exists()
        &&
        !newData.parent().parent().child('Inbox/'+$id).exists()
        )
        ||
        !newData.exists()
        ",
        ".validate":"newData.hasChildren(['time','topic','content'])",
        "time":{".validate":"root.child('Inbox/'+$id+'/time').val()==newData.val()"},
      	"email":{".validate":"root.child('Inbox/'+$id+'/email').val()==newData.val()"},
      	"topic":{".validate":"root.child('Inbox/'+$id+'/topic').val()==newData.val()"},
      	"content":{".validate":"root.child('Inbox/'+$id+'/content').val()==newData.val()"},
        "$other":{".validate":"false"}
    	}
    },
    "authorized":{
      "$id":{
        //$id:s are auth.uid:s of authorized clients
      }
    }
  }
}